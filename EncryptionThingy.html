<!DOCTYPE html>

<!--
Name: EncryptionThingy
Author: Chris DiMaio
Description: A Javascript driven tool for encrypting and attaching documents. 
-->

<html>
<head>
<link rel="shortcut icon" href="https://dl.dropboxusercontent.com/u/30063678/lock%20icon.png">
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/pbkdf2.js"></script>
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
</head>

<form name="dataform">
    <input type="text" name="iterations" id="iterations" disabled>
	<input type="text" name="length" id="length" disabled><br>
    <textarea id="datatextarea" rows="30" cols="150"></textarea>
	<textarea id="jsondata" rows="30" cols="150"></textarea>
</form>

<script type="text/javascript">
var PASS_PHRASE    = "hola chica!";

function encrypt(passphrase, plaintext) {
	var MAX_ITERATIONS = 2000;
	var MIN_ITERATIONS = 1000;

	var iterations = Math.floor(Math.random() * (MAX_ITERATIONS - MIN_ITERATIONS) + MIN_ITERATIONS);
	var iv         = CryptoJS.lib.WordArray.random(128/8);
	var salt       = CryptoJS.lib.WordArray.random(128/8);
	var key        = generateKey(passphrase, salt, iterations);
	var encrypted  = CryptoJS.AES.encrypt(plaintext, key, { iv: iv });
	
	var cipherObject         = {};
	cipherObject.cipherText  = encrypted.ciphertext.toString(CryptoJS.enc.Base64);
	cipherObject.contentType = getContentType(plaintext);
	cipherObject.iterations  = iterations;
	cipherObject.iv          = iv;
	cipherObject.salt        = salt;
	
	return cipherObject;
}

function decrypt(passphrase, cipherObject) {
	var cipherText = CryptoJS.enc.Base64.parse(cipherObject.cipherText);
	var iterations = cipherObject.iterations;
	var iv         = cipherObject.iv;
	var salt       = cipherObject.salt;

	var key          = generateKey(PASS_PHRASE, salt, iterations);
	var cipherParams = CryptoJS.lib.CipherParams.create({ ciphertext: cipherText });
	var decrypted    = CryptoJS.AES.decrypt( cipherParams, key, { iv: iv });
	
	// This will change when we handle other content types then 'text/plain'.
	return decrypted.toString(CryptoJS.enc.Utf8);
}

function getContentType(data) {
	// This is the only content type we will deal with for now.
	return "text/plain";
}

function generateKey(passphrase, salt, iterations) {
	return CryptoJS.PBKDF2(passphrase, salt, { keySize: 256/32, iterations: iterations });
}

var testData  = "You are reading a super secret message!";
var jsonObj   = encrypt(PASS_PHRASE, testData);
var plaintext = decrypt(PASS_PHRASE, jsonObj);

document.forms['dataform']['iterations'].value   = "Iterations: " + jsonObj.iterations;
document.forms['dataform']['length'].value       = "Character count: " + plaintext.length;
document.forms['dataform']['datatextarea'].value = plaintext;
document.forms['dataform']['jsondata'].value     = JSON.stringify(jsonObj);

// Save this for later.
// window.alert(document.documentElement.outerHTML);
</script>

<script type="application/json" id="data">
{"cipherText":"dAY0fF2j41S78IJvXQDcfjAsOO2NHZpZm+BzQMBW51ufhUqOrF1xoIuxas6F8Z4A","contentType":"text/plain","iterations":1689,"iv":{"words":[1562286809,1736175072,846784569,-1677142640],"sigBytes":16},"salt":{"words":[1230117647,405340576,-1412777500,326205294],"sigBytes":16}}
</script>
</html>
